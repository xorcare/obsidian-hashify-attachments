name: Upload Release Assets

on:
  release:
    types: [created]
permissions:
  contents: write

env:
  PLUGIN_NAME: obsidian-hashify-attachments

jobs:
  upload-assets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Build plugin archive
        run: |
          mkdir '${{ env.PLUGIN_NAME }}'
          cp main.js manifest.json '${{ env.PLUGIN_NAME }}'
          zip -r '${{ env.PLUGIN_NAME }}-${{ github.ref_name }}.zip' '${{ env.PLUGIN_NAME }}'

      - name: Check mandatory files
        run: |
          if [ ! -f "manifest.json" ]; then
            echo "Missing manifest.json"
            exit 1
          fi
          if [ ! -f "main.js" ]; then
            echo "Missing main.js"
            exit 1
          fi
          if [ ! -f "${{ env.PLUGIN_NAME }}-${{ github.ref_name }}.zip" ]; then
            echo "Missing ${{ env.PLUGIN_NAME }}-${{ github.ref_name }}.zip"
            exit 1
          fi

      - name: Upload assets via gh cli
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: >
          gh release upload ${{ github.event.release.tag_name }} --clobber
          '${{ env.PLUGIN_NAME }}-${{ github.ref_name }}.zip'
          main.js
          manifest.json
